name: ç­¾åæž„å»ºå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'æž„å»ºAndroidç­¾åAPK/AAB'
        type: boolean
        default: true
      build_ios:
        description: 'æž„å»ºiOS (éœ€è¦ç­¾åé…ç½®)'
        type: boolean
        default: false
      build_windows:
        description: 'æž„å»ºWindows'
        type: boolean
        default: true
      upload_to_store:
        description: 'ä¸Šä¼ åˆ°åº”ç”¨å•†åº—'
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # æž„å»ºAndroidç­¾åç‰ˆæœ¬
  build-android-signed:
    runs-on: ubuntu-latest
    if: inputs.build_android
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®FlutterçŽ¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    # å¦‚æžœæœ‰ç­¾åå¯†é’¥ï¼Œåˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
    - name: åˆ›å»ºç­¾åé…ç½®
      if: env.ANDROID_KEYSTORE_BASE64 != ''
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # åˆ›å»ºkeystoreæ–‡ä»¶
        echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
        
        # åˆ›å»ºkey.propertiesæ–‡ä»¶
        cat > android/key.properties << EOF
        storePassword=$KEYSTORE_PASSWORD
        keyPassword=$KEY_PASSWORD
        keyAlias=$KEY_ALIAS
        storeFile=upload-keystore.jks
        EOF

    - name: æž„å»ºç­¾åAPK
      run: |
        if [ -f "android/key.properties" ]; then
          echo "ä½¿ç”¨ç­¾åé…ç½®æž„å»ºAPK"
          flutter build apk --release --split-per-abi
        else
          echo "æœªæ‰¾åˆ°ç­¾åé…ç½®ï¼Œæž„å»ºæ— ç­¾åAPK"
          flutter build apk --release --split-per-abi
        fi

    - name: æž„å»ºç­¾åAAB
      run: |
        if [ -f "android/key.properties" ]; then
          echo "ä½¿ç”¨ç­¾åé…ç½®æž„å»ºAAB"
          flutter build appbundle --release
        else
          echo "æœªæ‰¾åˆ°ç­¾åé…ç½®ï¼Œæž„å»ºæ— ç­¾åAAB"
          flutter build appbundle --release
        fi

    - name: ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: android-signed-apks
        path: |
          build/app/outputs/flutter-apk/*.apk
        retention-days: 30

    - name: ä¸Šä¼ AABæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: android-signed-aab
        path: build/app/outputs/bundle/release/*.aab
        retention-days: 30

    # å¦‚æžœå¯ç”¨äº†åº”ç”¨å•†åº—ä¸Šä¼ 
    - name: ä¸Šä¼ åˆ°Google Play Console
      if: inputs.upload_to_store && env.GOOGLE_PLAY_SERVICE_ACCOUNT != ''
      uses: r0adkll/upload-google-play@v1
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
      with:
        serviceAccountJsonPlainText: ${{ env.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.aiassistant.app
        releaseFiles: build/app/outputs/bundle/release/*.aab
        track: internal

  # æž„å»ºiOSç­¾åç‰ˆæœ¬
  build-ios-signed:
    runs-on: macos-latest
    if: inputs.build_ios
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®FlutterçŽ¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    # è®¾ç½®iOSç­¾å (éœ€è¦é…ç½®secrets)
    - name: è®¾ç½®iOSç­¾å
      if: env.IOS_CERTIFICATE_BASE64 != ''
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # åˆ›å»ºä¸´æ—¶keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        
        # å¯¼å…¥è¯ä¹¦
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        
        # å¯¼å…¥provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

    - name: æž„å»ºiOS
      run: |
        if [ -f "~/Library/MobileDevice/Provisioning Profiles/profile.mobileprovision" ]; then
          echo "ä½¿ç”¨ç­¾åé…ç½®æž„å»ºiOS"
          flutter build ios --release
        else
          echo "æœªæ‰¾åˆ°ç­¾åé…ç½®ï¼Œæž„å»ºæ— ç­¾åiOS"
          flutter build ios --release --no-codesign
        fi

    - name: åˆ›å»ºIPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ai-assistant-ios-signed.ipa Payload/
        mv ai-assistant-ios-signed.ipa ../../../

    - name: ä¸Šä¼ IPAæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ios-signed-ipa
        path: ai-assistant-ios-signed.ipa
        retention-days: 30

  # æž„å»ºWindowsç‰ˆæœ¬
  build-windows-signed:
    runs-on: windows-latest
    if: inputs.build_windows
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®FlutterçŽ¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    - name: å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop

    - name: æž„å»ºWindowsåº”ç”¨
      run: flutter build windows --release

    - name: æž„å»ºMSIXåŒ…
      run: flutter pub run msix:create

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "ai-assistant-windows-signed.zip"

    - name: ä¸Šä¼ Windowsæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: windows-signed-build
        path: |
          ai-assistant-windows-signed.zip
          build/windows/x64/runner/Release/*.msix
        retention-days: 30

  # æž„å»ºæ‘˜è¦
  build-summary:
    runs-on: ubuntu-latest
    needs: [build-android-signed, build-ios-signed, build-windows-signed]
    if: always()
    
    steps:
    - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "## ðŸ—ï¸ ç­¾åæž„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ | æž„å»º |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ inputs.build_android }}" == "true" ]]; then
          echo "| Android | ${{ needs.build-android-signed.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} | å·²å¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Android | â­ï¸ è·³è¿‡ | æœªå¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ inputs.build_ios }}" == "true" ]]; then
          echo "| iOS | ${{ needs.build-ios-signed.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} | å·²å¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| iOS | â­ï¸ è·³è¿‡ | æœªå¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ inputs.build_windows }}" == "true" ]]; then
          echo "| Windows | ${{ needs.build-windows-signed.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} | å·²å¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Windows | â­ï¸ è·³è¿‡ | æœªå¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "æ‰€æœ‰æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ°å·¥ä½œæµçš„Artifactsä¸­ï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY 