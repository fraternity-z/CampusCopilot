name: æŒç»­é›†æˆæ„å»º

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
    # æ’é™¤æ ‡ç­¾æ¨é€ï¼Œé¿å…ä¸å‘å¸ƒå·¥ä½œæµå†²çª
    tags-ignore:
      - '**'

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # å¿«é€Ÿæ£€æŸ¥å’Œæµ‹è¯•
  test-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: dart format --output=none --set-exit-if-changed .

    - name: ä»£ç åˆ†æ
      run: flutter analyze

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: flutter test --coverage --reporter=expanded

    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # Androidæ„å»ºæµ‹è¯•
  build-android-test:
    runs-on: ubuntu-latest
    needs: test-and-analyze
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    - name: æ„å»ºAndroid APK (è°ƒè¯•ç‰ˆ)
      run: flutter build apk --debug

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7

  # Windowsæ„å»ºæµ‹è¯•
  build-windows-test:
    runs-on: windows-latest
    needs: test-and-analyze
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    - name: å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop

    - name: æ„å»ºWindowsåº”ç”¨ (è°ƒè¯•ç‰ˆ)
      run: flutter build windows --debug

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-debug-build
        path: build/windows/x64/runner/Debug/
        retention-days: 7

  # iOSæ„å»ºæµ‹è¯• (ä»…åœ¨macOSä¸Šè¿è¡Œ)
  build-ios-test:
    runs-on: macos-latest
    needs: test-and-analyze
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…ä¾èµ–
      run: flutter pub get

    - name: æ„å»ºiOS (è°ƒè¯•ç‰ˆï¼Œæ— ç­¾å)
      run: flutter build ios --debug --no-codesign

  # æ„å»ºçŠ¶æ€æ±‡æ€»
  build-status:
    runs-on: ubuntu-latest
    needs: [test-and-analyze, build-android-test, build-windows-test]
    if: always()
    
    steps:
    - name: æ£€æŸ¥æ„å»ºçŠ¶æ€
      run: |
        echo "## ğŸ” æ„å»ºçŠ¶æ€æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| æµ‹è¯•ä¸åˆ†æ | ${{ needs.test-and-analyze.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Androidæ„å»º | ${{ needs.build-android-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Windowsæ„å»º | ${{ needs.build-windows-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.test-and-analyze.result }}" == "success" && "${{ needs.build-android-test.result }}" == "success" && "${{ needs.build-windows-test.result }}" == "success" ]]; then
          echo "ğŸ‰ æ‰€æœ‰æ„å»ºå‡æˆåŠŸå®Œæˆï¼"
          exit 0
        else
          echo "âŒ éƒ¨åˆ†æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        fi 