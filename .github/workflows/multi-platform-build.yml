name: Multi-Platform Build and Release

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: ''
      release_notes:
        description: 'Release notes'
        required: false
        default: 'Automated build from GitHub Actions'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
      build_time: ${{ steps.version.outputs.build_time }}
    steps:
      - name: Generate version info
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "tag=${{ github.event.inputs.version_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=v$(date +'%Y.%m.%d')-build.$(date +'%H%M')" >> $GITHUB_OUTPUT
          fi
          echo "build_time=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

  build-windows:
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Windows app
        run: flutter build windows --release

      - name: Create Windows portable package
        run: |
          $buildPath = "build\windows\x64\runner\Release"
          $packagePath = "AnywhereChat-Windows-${{ needs.prepare.outputs.version_tag }}"
          
          # Create package directory
          New-Item -ItemType Directory -Path $packagePath -Force
          
          # Copy all files from build output
          Copy-Item -Path "$buildPath\*" -Destination $packagePath -Recurse -Force
          
          # Create a simple launcher script
          @"
          @echo off
          cd /d "%~dp0"
          start "" "anywherechat.exe"
          "@ | Out-File -FilePath "$packagePath\å¯åŠ¨AnywhereChat.bat" -Encoding ASCII
          
          # Create README
          @"
          AnywhereChat Windows Portable Version
          
          è¿è¡Œæ–¹å¼ï¼š
          1. åŒå‡» anywherechat.exe ç›´æŽ¥è¿è¡Œ
          2. æˆ–åŒå‡» å¯åŠ¨AnywhereChat.bat è¿è¡Œ
          
          ç³»ç»Ÿè¦æ±‚ï¼š
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - 64ä½ç³»ç»Ÿ
          
          æž„å»ºæ—¶é—´ï¼š${{ needs.prepare.outputs.build_time }}
          ç‰ˆæœ¬æ ‡ç­¾ï¼š${{ needs.prepare.outputs.version_tag }}
          "@ | Out-File -FilePath "$packagePath\README.txt" -Encoding UTF8
          
          # Create ZIP package
          Compress-Archive -Path $packagePath -DestinationPath "$packagePath.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: AnywhereChat-Windows-${{ needs.prepare.outputs.version_tag }}.zip

  build-android:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Android APK (Release)
        run: flutter build apk --release

      - name: Build Android APK (Debug)
        run: flutter build apk --debug

      - name: Rename APK files
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             AnywhereChat-Android-Release-${{ needs.prepare.outputs.version_tag }}.apk
          mv build/app/outputs/flutter-apk/app-debug.apk \
             AnywhereChat-Android-Debug-${{ needs.prepare.outputs.version_tag }}.apk

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            AnywhereChat-Android-Release-${{ needs.prepare.outputs.version_tag }}.apk
            AnywhereChat-Android-Debug-${{ needs.prepare.outputs.version_tag }}.apk

  build-ios:
    runs-on: macos-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build iOS app (without signing)
        run: |
          flutter build ios --release --no-codesign
        continue-on-error: true

      - name: Create iOS build info
        run: |
          mkdir -p ios-build
          if [ -d "build/ios/iphoneos" ]; then
            echo "iOS build completed successfully" > ios-build/build-status.txt
            echo "Build time: ${{ needs.prepare.outputs.build_time }}" >> ios-build/build-status.txt
            echo "Version: ${{ needs.prepare.outputs.version_tag }}" >> ios-build/build-status.txt
            echo "" >> ios-build/build-status.txt
            echo "Note: This is an unsigned iOS build." >> ios-build/build-status.txt
            echo "To install on device, you need to:" >> ios-build/build-status.txt
            echo "1. Open the project in Xcode" >> ios-build/build-status.txt
            echo "2. Configure code signing" >> ios-build/build-status.txt
            echo "3. Build and deploy from Xcode" >> ios-build/build-status.txt
            
            # Try to create archive info
            if [ -f "build/ios/iphoneos/Runner.app/Info.plist" ]; then
              cp -r build/ios/iphoneos ios-build/
            fi
          else
            echo "iOS build failed or incomplete" > ios-build/build-status.txt
            echo "This may be due to missing code signing configuration." >> ios-build/build-status.txt
          fi

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: ios-build/

  create-release:
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-android, build-ios]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          # AnywhereChat ${{ needs.prepare.outputs.version_tag }}
          
          **æž„å»ºæ—¶é—´**: ${{ needs.prepare.outputs.build_time }}
          
          ## ðŸ“¦ æž„å»ºäº§ç‰©
          
          ### Windows
          - âœ… Windows ä¾¿æºç‰ˆ (64ä½)
          - æ”¯æŒ Windows 10 åŠæ›´é«˜ç‰ˆæœ¬
          - æ— éœ€å®‰è£…ï¼Œè§£åŽ‹å³ç”¨
          
          ### Android
          - âœ… Release APK (ç”Ÿäº§ç‰ˆæœ¬)
          - âœ… Debug APK (è°ƒè¯•ç‰ˆæœ¬)
          - æ”¯æŒ Android 5.0 (API 21) åŠæ›´é«˜ç‰ˆæœ¬
          
          ### iOS
          - âš ï¸ æœªç­¾åæž„å»º (éœ€è¦åœ¨Xcodeä¸­é…ç½®ç­¾å)
          - æ”¯æŒ iOS 12.0 åŠæ›´é«˜ç‰ˆæœ¬
          
          ## ðŸ“ å‘å¸ƒè¯´æ˜Ž
          
          ${{ github.event.inputs.release_notes }}
          
          ## ðŸ”§ æŠ€æœ¯ä¿¡æ¯

          - **Flutterç‰ˆæœ¬**: 3.24.5
          - **Dartç‰ˆæœ¬**: 3.8.1
          - **æž„å»ºçŽ¯å¢ƒ**: GitHub Actions
          - **è®¸å¯è¯**: åŒé‡è®¸å¯è¯ (Apache 2.0 / å•†ä¸šè®¸å¯è¯)
          
          ## ðŸ“ž æ”¯æŒ
          
          - å•†ä¸šè®¸å¯è¯å’¨è¯¢: 927751260@qq.com
          - æŠ€æœ¯æ”¯æŒ: GitHub Issues
          
          ---
          
          *æ­¤ç‰ˆæœ¬é€šè¿‡GitHub Actionsè‡ªåŠ¨æž„å»º*
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.version_tag }}
          name: AnywhereChat ${{ needs.prepare.outputs.version_tag }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            windows-build/AnywhereChat-Windows-${{ needs.prepare.outputs.version_tag }}.zip
            android-build/AnywhereChat-Android-Release-${{ needs.prepare.outputs.version_tag }}.apk
            android-build/AnywhereChat-Android-Debug-${{ needs.prepare.outputs.version_tag }}.apk
            ios-build/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
