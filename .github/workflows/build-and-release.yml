name: æ„å»ºå¹¶å‘å¸ƒè·¨å¹³å°åº”ç”¨

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºRelease
  actions: read    # éœ€è¦è¯»æƒé™æ¥è®¿é—®æ„å»ºäº§ç‰©

env:
  FLUTTER_VERSION: '3.35.0'

jobs:
  # å‡†å¤‡å‘å¸ƒ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    # æ³¨æ„ï¼šæˆ‘ä»¬ä¸åœ¨è¿™é‡Œåˆ›å»ºReleaseï¼Œè€Œæ˜¯åœ¨æ‰€æœ‰æ„å»ºå®Œæˆååˆ›å»º
    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      id: version
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
          echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        else
          VERSION="v$(date +'%Y.%m.%d')-build.$(date +'%H%M')"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi
        echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

  # æ„å»ºAndroid APK
  build-android:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      # ç¡®ä¿ä¸ä¼šæŠŠ Gradle CLI é€‰é¡¹å½“æˆ JVM é€‰é¡¹ä¼ ç»™ Java
      JAVA_TOOL_OPTIONS: ""
      GRADLE_OPTS: "-Dorg.gradle.daemon=false"

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true  # å¯ç”¨Flutterç¼“å­˜

    - name: è®¾ç½®JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '21'

    - name: å®‰è£… Android SDK ç»„ä»¶
      uses: android-actions/setup-android@v3
      with:
        packages: platform-tools platforms;android-35 build-tools;35.0.0

    - name: æ¸…ç†å¯èƒ½å†²çªçš„ç¯å¢ƒå˜é‡
      run: |
        # é˜²æ­¢ CI æˆ–ä¸Šæ¸¸ action æ³¨å…¥å¯¼è‡´ JVM è¯¯è¯»çš„å‚æ•°
        echo "JAVA_TOOL_OPTIONS=" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false" >> $GITHUB_ENV

    # ç¼“å­˜Gradleä¾èµ–
    - name: ç¼“å­˜Gradleä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # ç¼“å­˜Flutterä¾èµ–
    - name: ç¼“å­˜Flutterä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: è®¾ç½®Gradleç¯å¢ƒ
      run: |
        mkdir -p ~/.gradle
        # ä½¿ç”¨æ›´ä¿å®ˆçš„JVMé…ç½®ï¼Œé¿å…ä¸é¡¹ç›®é…ç½®å†²çª
        echo "org.gradle.jvmargs=-Xmx2G -XX:MaxMetaspaceSize=512m -XX:+UseG1GC" > ~/.gradle/gradle.properties
        echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties

        # éªŒè¯Javaç‰ˆæœ¬
        java -version
        echo "JAVA_HOME=$JAVA_HOME"

    - name: è¯Šæ–­æ„å»ºç¯å¢ƒ
      run: |
        echo "ğŸ” è¯Šæ–­æ„å»ºç¯å¢ƒ..."
        
        # æ£€æŸ¥Javaç¯å¢ƒ
        echo "=== Javaç¯å¢ƒ ==="
        java -version
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"
        
        # æ£€æŸ¥ç³»ç»Ÿèµ„æº
        echo "=== ç³»ç»Ÿèµ„æº ==="
        free -h || echo "æ— æ³•è·å–å†…å­˜ä¿¡æ¯"
        df -h || echo "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
        nproc || echo "æ— æ³•è·å–CPUæ ¸å¿ƒæ•°"
        
        # æ£€æŸ¥Gradleé…ç½®
        echo "=== Gradleé…ç½® ==="
        cat ~/.gradle/gradle.properties || echo "æœªæ‰¾åˆ°å…¨å±€gradle.properties"
        cat android/gradle.properties || echo "æœªæ‰¾åˆ°é¡¹ç›®gradle.properties"
        
        # æ£€æŸ¥Flutterç¯å¢ƒ
        echo "=== Flutterç¯å¢ƒ ==="
        flutter doctor -v
        flutter --version

    - name: å®‰è£…Flutterä¾èµ–
      run: |
        # åªåœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶æ¸…ç†
        if [ ! -d ".dart_tool" ]; then
          flutter clean
        fi
        flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    # åˆå§‹åŒ–Gradle Wrapperå¹¶é¢„çƒ­å®ˆæŠ¤è¿›ç¨‹
    - name: åˆå§‹åŒ–Gradle Wrapperå¹¶é¢„çƒ­å®ˆæŠ¤è¿›ç¨‹
      run: |
        echo "ğŸ” æ£€æŸ¥å½“å‰ç›®å½•ç»“æ„..."
        ls -la

        echo "ğŸ” æ£€æŸ¥androidç›®å½•..."
        ls -la android/

        cd android

        # ç¡®ä¿gradlewæ–‡ä»¶å­˜åœ¨å¹¶æœ‰æ‰§è¡Œæƒé™
        if [ ! -f "gradlew" ]; then
          echo "âŒ gradlewæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°ç”Ÿæˆ..."

          # å°è¯•ä½¿ç”¨gradle wrapperå‘½ä»¤é‡æ–°ç”Ÿæˆ
          if command -v gradle >/dev/null 2>&1; then
            echo "ğŸ“¦ ä½¿ç”¨gradleå‘½ä»¤é‡æ–°ç”Ÿæˆwrapper..."
            gradle wrapper --gradle-version 8.10.2
          else
            echo "âŒ gradleå‘½ä»¤ä¸å¯ç”¨ï¼Œæ‰‹åŠ¨åˆ›å»ºgradlew..."
            # ä»GitHubä¸‹è½½æ ‡å‡†çš„gradlewæ–‡ä»¶ï¼ˆä¸ Gradle 8.10.2 åŒ¹é…ï¼‰
            curl -L -o gradlew "https://raw.githubusercontent.com/gradle/gradle/v8.10.2/gradlew"
            curl -L -o gradlew.bat "https://raw.githubusercontent.com/gradle/gradle/v8.10.2/gradlew.bat"
          fi
        fi

        # ç¡®ä¿gradlewæœ‰æ‰§è¡Œæƒé™
        chmod +x gradlew
        chmod +x gradlew.bat 2>/dev/null || true

        # ç¡®ä¿gradle-wrapper.jarå­˜åœ¨
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "ğŸ“¦ ä¸‹è½½ gradle-wrapper.jar..."
          mkdir -p gradle/wrapper
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            "https://github.com/gradle/gradle/raw/v8.10.2/gradle/wrapper/gradle-wrapper.jar"
        fi

        # è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "init-gradle-wrapper.sh" ]; then
          echo "ğŸ”§ è¿è¡Œ Gradle Wrapper åˆå§‹åŒ–è„šæœ¬..."
          chmod +x init-gradle-wrapper.sh
          ./init-gradle-wrapper.sh
        fi

        # éªŒè¯gradlewå¯æ‰§è¡Œ
        echo "ğŸ” éªŒè¯gradlewæ–‡ä»¶..."
        ls -la gradlew
        file gradlew

        # é¢„çƒ­ Gradle å®ˆæŠ¤è¿›ç¨‹
        echo "ğŸ”¥ é¢„çƒ­ Gradle å®ˆæŠ¤è¿›ç¨‹..."
        echo "âœ… gradlew æ‰§è¡Œæƒé™å·²è®¾ç½®"
        echo "ğŸ§ª æµ‹è¯• gradlew..."
        
        # æ˜¾ç¤ºJavaç‰ˆæœ¬
        java -version
        
        echo "âœ… Gradle Wrapper åˆå§‹åŒ–æˆåŠŸ"
        
        # éªŒè¯gradlewæ–‡ä»¶
        echo "ğŸ” éªŒè¯gradlewæ–‡ä»¶..."
        ls -la gradlew
        file gradlew
        
        # é¢„çƒ­ Gradle å®ˆæŠ¤è¿›ç¨‹
        echo "ğŸ”¥ é¢„çƒ­ Gradle å®ˆæŠ¤è¿›ç¨‹..."
        java -version
        
        # æµ‹è¯•åŸºæœ¬çš„ gradle å‘½ä»¤ï¼Œä¸ä½¿ç”¨ tasks
        echo "ğŸ”§ æµ‹è¯• Gradle é…ç½®..."
        ./gradlew --version || {
          echo "âš ï¸ gradlew --version å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
          
          # é‡æ–°ä¸‹è½½ gradle-wrapper.jarï¼ˆ8.10.2ï¼‰
          echo "ğŸ“¦ é‡æ–°ä¸‹è½½ gradle-wrapper.jar..."
          mkdir -p gradle/wrapper
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            "https://github.com/gradle/gradle/raw/v8.10.2/gradle/wrapper/gradle-wrapper.jar"
          
          # å†æ¬¡å°è¯•
          ./gradlew --version
        }
        
        # å¦‚æœ --version æˆåŠŸï¼Œå†å°è¯• tasks å‘½ä»¤
        echo "ğŸ”§ éªŒè¯ Gradle ä»»åŠ¡..."
        ./gradlew help --quiet || {
          echo "âš ï¸ help å‘½ä»¤å¤±è´¥ï¼Œè·³è¿‡ä»»åŠ¡éªŒè¯..."
        }

    - name: æ„å»ºAndroid APK
      timeout-minutes: 30
      env:
        JAVA_OPTS: "-Xmx2G"
        GRADLE_OPTS: "-Dorg.gradle.daemon=false"
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»ºAndroid APK..."
        echo "ğŸ“Š æ„å»ºå¼€å§‹æ—¶é—´: $(date)"
        
        # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        echo "ğŸ” ç¯å¢ƒä¿¡æ¯:"
        echo "JAVA_HOME=$JAVA_HOME"
        echo "JAVA_OPTS=$JAVA_OPTS"
        echo "GRADLE_OPTS=$GRADLE_OPTS"
        java -version
        echo "Flutter ç‰ˆæœ¬:"
        flutter --version
        
        # æ˜¾ç¤ºç³»ç»Ÿèµ„æºä¿¡æ¯
        echo "ğŸ” ç³»ç»Ÿèµ„æºä¿¡æ¯:"
        free -h || echo "æ— æ³•è·å–å†…å­˜ä¿¡æ¯"
        df -h || echo "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
        
        # æ˜¾ç¤º Gradle é…ç½®
        echo "ğŸ” Gradle é…ç½®:"
        cat ~/.gradle/gradle.properties || echo "æœªæ‰¾åˆ°å…¨å±€ gradle.properties"
        cat android/gradle.properties || echo "æœªæ‰¾åˆ°é¡¹ç›® gradle.properties"
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º..."
        flutter clean
        
        # é‡æ–°è·å–ä¾èµ–
        echo "ğŸ“¦ é‡æ–°è·å–ä¾èµ–..."
        flutter pub get

        # ä½¿ç”¨ä¼˜åŒ–çš„æ„å»ºå‚æ•°
        echo "ğŸ”¨ å¼€å§‹æ„å»º..."
        flutter build apk --release --dart-define=flutter.inspector.structuredErrors=false --target-platform android-arm64,android-arm

        echo "âœ… Android APKæ„å»ºå®Œæˆ"
        echo "ğŸ“Š æ„å»ºç»“æŸæ—¶é—´: $(date)"

        # æ˜¾ç¤ºæ„å»ºäº§ç‰©ä¿¡æ¯
        echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
        ls -la build/app/outputs/flutter-apk/

    - name: æ‰“åŒ…Androidæ„å»ºäº§ç‰©
      run: |
        mkdir -p android-build

        # æ£€æŸ¥æ˜¯å¦æœ‰åˆ†æ¶æ„APKæ–‡ä»¶
        if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
          echo "ğŸ“± æ‰¾åˆ°åˆ†æ¶æ„APKæ–‡ä»¶ï¼Œå¼€å§‹æ‰“åŒ…..."

          # å¤åˆ¶æ‰€æœ‰æ¶æ„çš„APKæ–‡ä»¶
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk android-build/AnywhereChat-Android-${{ needs.prepare.outputs.version }}-arm64.apk

          # å¦‚æœæœ‰å…¶ä»–æ¶æ„çš„APKä¹Ÿå¤åˆ¶
          if [ -f "build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk" ]; then
            cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk android-build/AnywhereChat-Android-${{ needs.prepare.outputs.version }}-arm32.apk
          fi

        elif [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          echo "ğŸ“± æ‰¾åˆ°é€šç”¨APKæ–‡ä»¶..."
          cp build/app/outputs/flutter-apk/app-release.apk android-build/AnywhereChat-Android-${{ needs.prepare.outputs.version }}.apk
        else
          echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
          exit 1
        fi

        # æ˜¾ç¤ºæœ€ç»ˆçš„æ„å»ºäº§ç‰©
        echo "ğŸ“¦ æœ€ç»ˆæ„å»ºäº§ç‰©:"
        ls -la android-build/

    - name: ä¸Šä¼ Androidæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: |
          android-build/*.apk



  # æ„å»ºiOSåº”ç”¨
  build-ios:
    needs: prepare
    runs-on: macos-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: æ¸…ç†å¹¶å®‰è£…Flutterä¾èµ–
      run: |
        flutter clean
        rm -rf .dart_tool
        flutter pub get --no-precompile

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: è®¾ç½®iOSæ„å»ºç¯å¢ƒ
      run: |
        # å°è¯•é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„iOS SDKç‰ˆæœ¬
        if xcrun --sdk iphoneos --show-sdk-version 2>/dev/null | grep -q "17"; then
          echo "ä½¿ç”¨ iOS 17 SDK"
          export IOS_SDK_VERSION="17.0"
        elif xcrun --sdk iphoneos --show-sdk-version 2>/dev/null | grep -q "16"; then
          echo "ä½¿ç”¨ iOS 16 SDK" 
          export IOS_SDK_VERSION="16.0"
        else
          echo "ä½¿ç”¨é»˜è®¤ iOS SDK"
          export IOS_SDK_VERSION="15.0"
        fi
        
        echo "IOS_SDK_VERSION=$IOS_SDK_VERSION" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºXcodeå’ŒiOS SDKä¿¡æ¯
        xcrun --sdk iphoneos --show-sdk-version || echo "æ— æ³•è·å–iOS SDKç‰ˆæœ¬"
        xcodebuild -showsdks | grep -i ios || echo "æ— æ³•åˆ—å‡ºiOS SDK"

    - name: æ„å»ºiOSåº”ç”¨ï¼ˆæ— ç­¾åï¼‰
      run: |
        # æ£€æŸ¥å¯ç”¨çš„iOS SDKå¹¶ä½¿ç”¨åˆé€‚çš„ç‰ˆæœ¬
        echo "ğŸ” æ£€æŸ¥å¯ç”¨çš„iOS SDKç‰ˆæœ¬..."
        xcodebuild -showsdks | grep -i ios
        
        # è·å–å¯ç”¨çš„iOS SDKç‰ˆæœ¬
        AVAILABLE_IOS_SDK=$(xcodebuild -showsdks | grep 'iphoneos' | tail -1 | sed 's/.*iphoneos//' | xargs)
        echo "ğŸ“± ä½¿ç”¨iOS SDKç‰ˆæœ¬: $AVAILABLE_IOS_SDK"
        
        # æ„å»ºiOSåº”ç”¨ï¼ŒæŒ‡å®šSDKç‰ˆæœ¬
        echo "ğŸ“± å¼€å§‹æ„å»ºiOSåº”ç”¨..."
        flutter build ios --release --no-codesign \
          --dart-define=flutter.inspector.structuredErrors=false
      continue-on-error: true

    - name: åˆ›å»ºIPAæ–‡ä»¶
      run: |
        mkdir -p ios-build
        mkdir -p Payload

        # æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
        if [ -d "build/ios/iphoneos/Runner.app" ]; then
          echo "âœ… æ‰¾åˆ°iOSæ„å»ºäº§ç‰©ï¼Œå¼€å§‹åˆ›å»ºIPA..."

          # å¤åˆ¶.appåˆ°Payloadç›®å½•ï¼ˆIPAæ ‡å‡†ç»“æ„ï¼‰
          cp -r build/ios/iphoneos/Runner.app Payload/

          # åˆ›å»ºIPAæ–‡ä»¶ï¼ˆIPAæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ZIPæ–‡ä»¶ï¼‰
          zip -r AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.ipa Payload

          # ç§»åŠ¨IPAåˆ°æ„å»ºç›®å½•
          mv AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.ipa ios-build/

          # ä»…ä¿ç•™ IPA

          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "ğŸ“¦ æ‰“åŒ…å†…å®¹:"
          ls -la ios-build/

          # æ˜¾ç¤ºIPAæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“± IPAæ–‡ä»¶ä¿¡æ¯:"
          file ios-build/*.ipa

          echo "âœ… iOS IPAæ–‡ä»¶åˆ›å»ºå®Œæˆ"
        else
          echo "âŒ æœªæ‰¾åˆ°iOSæ„å»ºäº§ç‰©ï¼Œåˆ›å»ºé”™è¯¯ä¿¡æ¯..."

          # åˆ›å»ºé”™è¯¯ä¿¡æ¯
          echo "iOSæ„å»ºå¤±è´¥" > ios-build/build-error.txt
          echo "ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}" >> ios-build/build-error.txt
          echo "é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºäº§ç‰© build/ios/iphoneos/Runner.app" >> ios-build/build-error.txt
          echo "æ„å»ºæ—¶é—´: $(date)" >> ios-build/build-error.txt

          # æ˜¾ç¤ºæ„å»ºç›®å½•å†…å®¹ç”¨äºè°ƒè¯•
          echo "ğŸ” æ„å»ºç›®å½•å†…å®¹:"
          find build -name "*.app" -type d 2>/dev/null || echo "æœªæ‰¾åˆ°.appæ–‡ä»¶"
        fi

    - name: ä¸Šä¼ iOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: |
          ios-build/*.ipa

  # æ³¨æ„ï¼šWindowsæ„å»ºå·²è¢«ç§»é™¤ï¼Œå› ä¸ºæŒç»­å‡ºç°æ–‡ä»¶é”å®šé—®é¢˜




  # å®Œæˆå‘å¸ƒ
  finalize-release:
    needs: [prepare, build-android, build-ios]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4

    - name: è·å–å½“å‰æ—¶é—´
      id: current-time
      run: echo "time=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        name: Campus Copilot ${{ needs.prepare.outputs.version }}
        body: |
          # Campus Copilot ${{ needs.prepare.outputs.version }}

          **å‘å¸ƒæ—¶é—´**: ${{ steps.current-time.outputs.time }}

          ## ğŸ“¦ æ„å»ºäº§ç‰©

          ### ç§»åŠ¨ç«¯
          - âœ… **Android APK**: é€‚ç”¨äºAndroid 5.0+è®¾å¤‡ï¼Œå¯ç›´æ¥å®‰è£…
          - âœ… **iOS IPA**: æœªç­¾åIPAæ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æˆ–Xcodeç­¾ååå®‰è£…

          ### æ¡Œé¢ç«¯
          - âŒ **Windows**: æš‚æ—¶ç§»é™¤

          ## ğŸ”§ æŠ€æœ¯ä¿¡æ¯

          - **Flutterç‰ˆæœ¬**: ${{ env.FLUTTER_VERSION }}
          - **Dartç‰ˆæœ¬**: 3.8.1
          - **æ„å»ºç¯å¢ƒ**: GitHub Actions
          - **è®¸å¯è¯**: åŒé‡è®¸å¯è¯ (Apache 2.0 / å•†ä¸šè®¸å¯è¯)

          ## ğŸ“ æ”¯æŒ

          - å•†ä¸šè®¸å¯è¯å’¨è¯¢: 927751260@qq.com
          - æŠ€æœ¯æ”¯æŒ: GitHub Issues
        files: |
          android-build/*.apk
          ios-build/*.ipa
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ AnywhereChat è·¨å¹³å°æ„å»ºå®Œæˆ!"
        echo "ğŸ“± Android: âœ…"
        echo "ğŸ iOS: âœ…"
        echo "ğŸ–¥ï¸ Windows: âœ…"
        echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }}"