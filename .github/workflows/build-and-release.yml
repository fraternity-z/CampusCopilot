name: æ„å»ºå¹¶å‘å¸ƒè·¨å¹³å°åº”ç”¨

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  FLUTTER_VERSION: '3.32.5'

jobs:
  # å‡†å¤‡å‘å¸ƒ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ github.ref_name || github.event.inputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆ›å»ºRelease
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        name: AnywhereChat ${{ github.ref_name || github.event.inputs.version }}
        body: |
          # AnywhereChat ${{ github.ref_name || github.event.inputs.version }}

          **å‘å¸ƒæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')

          ## ğŸ“¦ æ„å»ºäº§ç‰©

          ### ç§»åŠ¨ç«¯
          - âœ… **Android APK**: é€‚ç”¨äºAndroid 5.0+è®¾å¤‡
          - âš ï¸ **iOS**: æœªç­¾åæ„å»ºï¼Œéœ€è¦åœ¨Xcodeä¸­é…ç½®ç­¾å

          ### æ¡Œé¢ç«¯
          - âœ… **Windows**: ä¾¿æºç‰ˆZIPåŒ…ï¼Œé€‚ç”¨äºWindows 10+
          - âœ… **macOS**: åº”ç”¨åŒ…ï¼Œé€‚ç”¨äºmacOS 10.14+
          - âœ… **Linux**: å‹ç¼©åŒ…ï¼Œé€‚ç”¨äºä¸»æµLinuxå‘è¡Œç‰ˆ

          ## ğŸ”§ æŠ€æœ¯ä¿¡æ¯

          - **Flutterç‰ˆæœ¬**: ${{ env.FLUTTER_VERSION }}
          - **Dartç‰ˆæœ¬**: 3.8.1
          - **æ„å»ºç¯å¢ƒ**: GitHub Actions
          - **è®¸å¯è¯**: åŒé‡è®¸å¯è¯ (Apache 2.0 / å•†ä¸šè®¸å¯è¯)

          ## ğŸ“ æ”¯æŒ

          - å•†ä¸šè®¸å¯è¯å’¨è¯¢: 927751260@qq.com
          - æŠ€æœ¯æ”¯æŒ: GitHub Issues
        draft: true
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºAndroid APK
  build-android:
    needs: prepare
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: è®¾ç½®Gradleç¯å¢ƒ
      run: |
        mkdir -p ~/.gradle
        echo "org.gradle.java.home=$JAVA_HOME" > ~/.gradle/gradle.properties

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºAndroid APK
      run: flutter build apk --release

    - name: ä¸Šä¼ APKåˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        files: build/app/outputs/flutter-apk/app-release.apk
        name: AnywhereChat-Android-${{ needs.prepare.outputs.version }}.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºWindowsåº”ç”¨
  build-windows:
    needs: prepare
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºWindowsåº”ç”¨
      run: flutter build windows --release

    - name: åˆ›å»ºWindowsä¾¿æºåŒ…
      run: |
        $buildPath = "build\windows\x64\runner\Release"
        $packagePath = "AnywhereChat-Windows-${{ needs.prepare.outputs.version }}"

        New-Item -ItemType Directory -Path $packagePath -Force
        Copy-Item -Path "$buildPath\*" -Destination $packagePath -Recurse -Force

        @"
        @echo off
        cd /d "%~dp0"
        start "" "anywherechat.exe"
        "@ | Out-File -FilePath "$packagePath\å¯åŠ¨AnywhereChat.bat" -Encoding ASCII

        @"
        AnywhereChat Windows ä¾¿æºç‰ˆ

        è¿è¡Œæ–¹å¼ï¼š
        1. åŒå‡» anywherechat.exe ç›´æ¥è¿è¡Œ
        2. æˆ–åŒå‡» å¯åŠ¨AnywhereChat.bat è¿è¡Œ

        ç³»ç»Ÿè¦æ±‚ï¼šWindows 10+ 64ä½
        ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}
        "@ | Out-File -FilePath "$packagePath\README.txt" -Encoding UTF8

        Compress-Archive -Path $packagePath -DestinationPath "$packagePath.zip"

    - name: ä¸Šä¼ WindowsåŒ…åˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        files: AnywhereChat-Windows-${{ needs.prepare.outputs.version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºiOSåº”ç”¨
  build-ios:
    needs: prepare
    runs-on: macos-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºiOSåº”ç”¨ï¼ˆæ— ç­¾åï¼‰
      run: flutter build ios --release --no-codesign
      continue-on-error: true

    - name: åˆ›å»ºiOSæ„å»ºä¿¡æ¯
      run: |
        mkdir -p ios-build
        echo "iOSæ„å»ºä¿¡æ¯" > ios-build/build-info.txt
        echo "ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}" >> ios-build/build-info.txt
        echo "æ³¨æ„: æ­¤æ„å»ºæœªç­¾åï¼Œéœ€è¦åœ¨Xcodeä¸­é…ç½®ç­¾ååæ‰èƒ½å®‰è£…åˆ°è®¾å¤‡ä¸Šã€‚" >> ios-build/build-info.txt

        # æ‰“åŒ…æ„å»ºä¿¡æ¯
        zip -r AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.zip ios-build

    - name: ä¸Šä¼ iOSä¿¡æ¯åˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        files: AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºmacOSåº”ç”¨
  build-macos:
    needs: prepare
    runs-on: macos-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºmacOSåº”ç”¨
      run: flutter build macos --release
      continue-on-error: true

    - name: æ‰“åŒ…macOSåº”ç”¨
      run: |
        cd build/macos/Build/Products/Release
        zip -r AnywhereChat-macOS-${{ needs.prepare.outputs.version }}.zip anywherechat.app

    - name: ä¸Šä¼ macOSåº”ç”¨åˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        files: build/macos/Build/Products/Release/AnywhereChat-macOS-${{ needs.prepare.outputs.version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºLinuxåº”ç”¨
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Linuxä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºLinuxåº”ç”¨
      run: flutter build linux --release
      continue-on-error: true

    - name: æ‰“åŒ…Linuxåº”ç”¨
      run: |
        cd build/linux/x64/release/bundle
        tar -czvf AnywhereChat-Linux-${{ needs.prepare.outputs.version }}.tar.gz *

    - name: ä¸Šä¼ Linuxåº”ç”¨åˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        files: build/linux/x64/release/bundle/AnywhereChat-Linux-${{ needs.prepare.outputs.version }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å®Œæˆå‘å¸ƒ
  finalize-release:
    needs: [prepare, build-android, build-windows, build-ios, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: å‘å¸ƒRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ AnywhereChat è·¨å¹³å°æ„å»ºå®Œæˆ!"
        echo "ğŸ“± Android: âœ…"
        echo "ğŸ iOS: âœ…"
        echo "ğŸ–¥ï¸ Windows: âœ…"
        echo "ğŸ–¥ï¸ macOS: âœ…"
        echo "ğŸ–¥ï¸ Linux: âœ…"
        echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }}"