name: æ„å»ºå¹¶å‘å¸ƒè·¨å¹³å°åº”ç”¨

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºRelease
  actions: read    # éœ€è¦è¯»æƒé™æ¥è®¿é—®æ„å»ºäº§ç‰©

env:
  FLUTTER_VERSION: '3.32.5'

jobs:
  # å‡†å¤‡å‘å¸ƒ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    # æ³¨æ„ï¼šæˆ‘ä»¬ä¸åœ¨è¿™é‡Œåˆ›å»ºReleaseï¼Œè€Œæ˜¯åœ¨æ‰€æœ‰æ„å»ºå®Œæˆååˆ›å»º
    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      id: version
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
          echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        else
          VERSION="v$(date +'%Y.%m.%d')-build.$(date +'%H%M')"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi
        echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

  # æ„å»ºAndroid APK
  build-android:
    needs: prepare
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: è®¾ç½®JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '21'

    - name: è®¾ç½®Gradleç¯å¢ƒ
      run: |
        mkdir -p ~/.gradle
        echo "org.gradle.java.home=$JAVA_HOME" > ~/.gradle/gradle.properties
        echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g" >> ~/.gradle/gradle.properties
        echo "org.gradle.java.target=21" >> ~/.gradle/gradle.properties

        # éªŒè¯Javaç‰ˆæœ¬
        java -version
        echo "JAVA_HOME=$JAVA_HOME"

    - name: æ¸…ç†å¹¶å®‰è£…Flutterä¾èµ–
      run: |
        flutter clean
        rm -rf .dart_tool
        flutter pub get --no-precompile

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºAndroid APK
      run: |
        echo "å¼€å§‹æ„å»ºAndroid APK..."
        flutter build apk --release --verbose
        echo "Android APKæ„å»ºå®Œæˆ"

    - name: é‡å‘½åAPKæ–‡ä»¶
      run: |
        mv build/app/outputs/flutter-apk/app-release.apk AnywhereChat-Android-${{ needs.prepare.outputs.version }}.apk

    - name: ä¸Šä¼ Androidæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: AnywhereChat-Android-${{ needs.prepare.outputs.version }}.apk



  # æ„å»ºiOSåº”ç”¨
  build-ios:
    needs: prepare
    runs-on: macos-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: æ¸…ç†å¹¶å®‰è£…Flutterä¾èµ–
      run: |
        flutter clean
        rm -rf .dart_tool
        flutter pub get --no-precompile

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºiOSåº”ç”¨ï¼ˆæ— ç­¾åï¼‰
      run: flutter build ios --release --no-codesign
      continue-on-error: true

    - name: åˆ›å»ºIPAæ–‡ä»¶
      run: |
        mkdir -p ios-build
        mkdir -p Payload

        # æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
        if [ -d "build/ios/iphoneos/Runner.app" ]; then
          echo "âœ… æ‰¾åˆ°iOSæ„å»ºäº§ç‰©ï¼Œå¼€å§‹åˆ›å»ºIPA..."

          # å¤åˆ¶.appåˆ°Payloadç›®å½•ï¼ˆIPAæ ‡å‡†ç»“æ„ï¼‰
          cp -r build/ios/iphoneos/Runner.app Payload/

          # åˆ›å»ºIPAæ–‡ä»¶ï¼ˆIPAæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ZIPæ–‡ä»¶ï¼‰
          zip -r AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.ipa Payload

          # ç§»åŠ¨IPAåˆ°æ„å»ºç›®å½•
          mv AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.ipa ios-build/

          # åŒæ—¶ä¿ç•™.appæ–‡ä»¶ä¾›å¼€å‘è€…ä½¿ç”¨
          cp -r build/ios/iphoneos/Runner.app ios-build/

          # åˆ›å»ºå®‰è£…è¯´æ˜
          cat > ios-build/README.md << 'INSTALL_README'
          # AnywhereChat iOS å®‰è£…è¯´æ˜

          ## ğŸ“± æ–‡ä»¶è¯´æ˜
          - AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-unsigned.ipa - æœªç­¾åçš„IPAæ–‡ä»¶
          - Runner.app - åº”ç”¨åŒ…æ–‡ä»¶ï¼ˆä¾›å¼€å‘è€…ä½¿ç”¨ï¼‰

          ## ğŸ”§ å®‰è£…æ–¹æ³•

          ### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼ˆæ¨èï¼‰
          1. ä¸‹è½½ AltStore æˆ– Sideloadly
          2. ä½¿ç”¨å·¥å…·å®‰è£… .ipa æ–‡ä»¶åˆ°è®¾å¤‡

          ### æ–¹æ³•äºŒï¼šä½¿ç”¨Xcodeï¼ˆéœ€è¦å¼€å‘è€…è´¦å·ï¼‰
          1. æ‰“å¼€Xcode
          2. å°† Runner.app æ‹–æ‹½åˆ°Xcodeä¸­
          3. é…ç½®ç­¾åè¯ä¹¦
          4. å®‰è£…åˆ°è®¾å¤‡

          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - æ­¤æ„å»ºæœªç­¾åï¼Œæ— æ³•ç›´æ¥å®‰è£…
          - éœ€è¦æœ‰æ•ˆçš„Appleå¼€å‘è€…è¯ä¹¦è¿›è¡Œç­¾å
          - å®‰è£…åå¯èƒ½éœ€è¦åœ¨è®¾ç½®ä¸­ä¿¡ä»»å¼€å‘è€…
          INSTALL_README

          # åˆ›å»ºæ„å»ºä¿¡æ¯
          echo "iOSæ„å»ºä¿¡æ¯" > ios-build/build-info.txt
          echo "ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}" >> ios-build/build-info.txt
          echo "æ„å»ºæ—¶é—´: $(date)" >> ios-build/build-info.txt
          echo "æ–‡ä»¶ç±»å‹: IPA (iOS App Package)" >> ios-build/build-info.txt
          echo "ç­¾åçŠ¶æ€: æœªç­¾å" >> ios-build/build-info.txt

          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "ğŸ“¦ æ‰“åŒ…å†…å®¹:"
          ls -la ios-build/

          # æ˜¾ç¤ºIPAæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“± IPAæ–‡ä»¶ä¿¡æ¯:"
          file ios-build/*.ipa

          echo "âœ… iOS IPAæ–‡ä»¶åˆ›å»ºå®Œæˆ"
        else
          echo "âŒ æœªæ‰¾åˆ°iOSæ„å»ºäº§ç‰©ï¼Œåˆ›å»ºé”™è¯¯ä¿¡æ¯..."

          # åˆ›å»ºé”™è¯¯ä¿¡æ¯
          echo "iOSæ„å»ºå¤±è´¥" > ios-build/build-error.txt
          echo "ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}" >> ios-build/build-error.txt
          echo "é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºäº§ç‰© build/ios/iphoneos/Runner.app" >> ios-build/build-error.txt
          echo "æ„å»ºæ—¶é—´: $(date)" >> ios-build/build-error.txt

          # æ˜¾ç¤ºæ„å»ºç›®å½•å†…å®¹ç”¨äºè°ƒè¯•
          echo "ğŸ” æ„å»ºç›®å½•å†…å®¹:"
          find build -name "*.app" -type d 2>/dev/null || echo "æœªæ‰¾åˆ°.appæ–‡ä»¶"
        fi

    - name: ä¸Šä¼ iOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: AnywhereChat-iOS-${{ needs.prepare.outputs.version }}-*.zip

  # æ³¨æ„ï¼šWindowsæ„å»ºå·²è¢«ç§»é™¤ï¼Œå› ä¸ºæŒç»­å‡ºç°æ–‡ä»¶é”å®šé—®é¢˜




  # å®Œæˆå‘å¸ƒ
  finalize-release:
    needs: [prepare, build-android, build-ios]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4

    - name: è·å–å½“å‰æ—¶é—´
      id: current-time
      run: echo "time=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.version }}
        name: AnywhereChat ${{ needs.prepare.outputs.version }}
        body: |
          # AnywhereChat ${{ needs.prepare.outputs.version }}

          **å‘å¸ƒæ—¶é—´**: ${{ steps.current-time.outputs.time }}

          ## ğŸ“¦ æ„å»ºäº§ç‰©

          ### ç§»åŠ¨ç«¯
          - âœ… **Android APK**: é€‚ç”¨äºAndroid 5.0+è®¾å¤‡ï¼Œå¯ç›´æ¥å®‰è£…
          - âœ… **iOS IPA**: æœªç­¾åIPAæ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æˆ–Xcodeç­¾ååå®‰è£…

          ### æ¡Œé¢ç«¯
          - âŒ **Windows**: æš‚æ—¶ç§»é™¤ï¼ˆæ–‡ä»¶é”å®šé—®é¢˜ï¼‰

          ## ğŸ”§ æŠ€æœ¯ä¿¡æ¯

          - **Flutterç‰ˆæœ¬**: ${{ env.FLUTTER_VERSION }}
          - **Dartç‰ˆæœ¬**: 3.8.1
          - **æ„å»ºç¯å¢ƒ**: GitHub Actions
          - **è®¸å¯è¯**: åŒé‡è®¸å¯è¯ (Apache 2.0 / å•†ä¸šè®¸å¯è¯)

          ## ğŸ“ æ”¯æŒ

          - å•†ä¸šè®¸å¯è¯å’¨è¯¢: 927751260@qq.com
          - æŠ€æœ¯æ”¯æŒ: GitHub Issues
        files: |
          android-build/*
          ios-build/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ AnywhereChat è·¨å¹³å°æ„å»ºå®Œæˆ!"
        echo "ğŸ“± Android: âœ…"
        echo "ğŸ iOS: âœ…"
        echo "ğŸ–¥ï¸ Windows: âœ…"
        echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }}"