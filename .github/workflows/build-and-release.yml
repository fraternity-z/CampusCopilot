name: æ„å»ºå¹¶å‘å¸ƒè·¨å¹³å°åº”ç”¨

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  FLUTTER_VERSION: '3.24.5'

jobs:
  # æ„å»ºAndroid APK
  build-android:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: ç”Ÿæˆä»£ç 
      run: dart run build_runner build --delete-conflicting-outputs

    - name: æ„å»ºAndroid APK
      run: flutter build apk --release --split-per-abi

    - name: æ„å»ºAndroid AAB
      run: flutter build appbundle --release

    - name: åˆ›å»ºRelease
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        release_name: AI Assistant ${{ github.ref_name || github.event.inputs.version }}
        draft: false
        prerelease: false
        body: |
          ## ğŸš€ AI Assistant ${{ github.ref_name || github.event.inputs.version }}
          
          ### ğŸ“± æ”¯æŒå¹³å°
          - âœ… Android (APK/AAB)
          - âœ… iOS (IPA)
          - âœ… Windows (EXE/MSIX)
          
          ### ğŸ“ ä¸‹è½½æ–‡ä»¶
          - **Androidç”¨æˆ·**: ä¸‹è½½ `ai-assistant-android.apk`
          - **iOSç”¨æˆ·**: ä¸‹è½½ `ai-assistant-ios.ipa` (éœ€è¦ä¼ä¸šç­¾åæˆ–è‡ªç­¾å)
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `ai-assistant-windows.zip` æˆ– `ai-assistant-windows.msix`
          
          ### ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯
          - Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

    - name: ä¸Šä¼ Android APK (ARM64)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
        asset_name: ai-assistant-android-arm64.apk
        asset_content_type: application/vnd.android.package-archive

    - name: ä¸Šä¼ Android APK (ARM)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
        asset_name: ai-assistant-android-arm.apk
        asset_content_type: application/vnd.android.package-archive

    - name: ä¸Šä¼ Android APK (x64)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/app/outputs/flutter-apk/app-x86_64-release.apk
        asset_name: ai-assistant-android-x64.apk
        asset_content_type: application/vnd.android.package-archive

    - name: ä¸Šä¼ Android AAB
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/app/outputs/bundle/release/app-release.aab
        asset_name: ai-assistant-android.aab
        asset_content_type: application/octet-stream

  # æ„å»ºiOS IPA
  build-ios:
    runs-on: macos-latest
    needs: build-android
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: æ„å»ºiOS (æ— ç­¾å)
      run: flutter build ios --release --no-codesign

    - name: åˆ›å»ºIPAåŒ…
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ai-assistant-ios.ipa Payload/
        mv ai-assistant-ios.ipa ../../../

    - name: ä¸Šä¼ iOS IPA
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.build-android.outputs.upload_url }}
        asset_path: ai-assistant-ios.ipa
        asset_name: ai-assistant-ios.ipa
        asset_content_type: application/octet-stream

  # æ„å»ºWindows EXE
  build-windows:
    runs-on: windows-latest
    needs: build-android
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        architecture: x64

    - name: å®‰è£…Flutterä¾èµ–
      run: flutter pub get

    - name: å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop

    - name: æ„å»ºWindowsåº”ç”¨
      run: flutter build windows --release

    - name: æ„å»ºMSIXåŒ…
      run: flutter pub run msix:create

    - name: åˆ›å»ºWindowså‘å¸ƒåŒ…
      run: |
        Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "ai-assistant-windows.zip"

    - name: ä¸Šä¼ Windows ZIP
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.build-android.outputs.upload_url }}
        asset_path: ai-assistant-windows.zip
        asset_name: ai-assistant-windows.zip
        asset_content_type: application/zip

    - name: ä¸Šä¼ Windows MSIX
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.build-android.outputs.upload_url }}
        asset_path: build\windows\x64\runner\Release\ai_assistant.msix
        asset_name: ai-assistant-windows.msix
        asset_content_type: application/octet-stream
      continue-on-error: true

  # æ„å»ºä¿¡æ¯æ±‡æ€»
  build-summary:
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-windows]
    if: always()
    
    steps:
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ AI Assistant è·¨å¹³å°æ„å»ºå®Œæˆ!"
        echo "ğŸ“± Android: âœ…"
        echo "ğŸ iOS: âœ…" 
        echo "ğŸ–¥ï¸ Windows: âœ…"
        echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name || github.event.inputs.version }}" 